<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Agentes - WhatsApp</title>
    <link rel="stylesheet" href="css/chat-agentes.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <img src="/images/logo.png" alt="BSL" class="header-logo" onerror="this.style.display='none'">
                <h1>Agente de Chat</h1>
            </div>
            <div class="header-center">
                <div class="estado-selector">
                    <label for="estadoAgente">Estado:</label>
                    <select id="estadoAgente" onchange="cambiarEstado()">
                        <option value="disponible">ðŸŸ¢ Disponible</option>
                        <option value="ocupado">ðŸŸ¡ Ocupado</option>
                        <option value="ausente">ðŸŸ  Ausente</option>
                        <option value="offline">ðŸ”´ Offline</option>
                    </select>
                </div>
            </div>
            <div class="header-right">
                <span id="nombreAgente" class="agente-nombre"></span>
                <button onclick="cerrarSesion()" class="btn-logout">Cerrar sesiÃ³n</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar: Lista de conversaciones -->
            <aside class="conversaciones-sidebar">
                <div class="sidebar-header">
                    <h2>Conversaciones</h2>
                    <span id="contadorConversaciones" class="contador-badge">0</span>
                </div>

                <div class="sidebar-filtros">
                    <input type="text" id="buscarConversacion" placeholder="Buscar por nombre o telÃ©fono..." oninput="filtrarConversaciones()">
                    <select id="filtroEstado" onchange="cargarConversaciones()">
                        <option value="activa">Activas</option>
                        <option value="nueva">Nuevas</option>
                        <option value="todas">Todas</option>
                        <option value="cerrada">Cerradas</option>
                    </select>
                </div>

                <div id="listaConversaciones" class="conversaciones-lista">
                    <!-- Las conversaciones se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
                    <div class="loading-spinner">Cargando conversaciones...</div>
                </div>
            </aside>

            <!-- Chat Area -->
            <section class="chat-area">
                <div id="chat-vacio" class="chat-vacio">
                    <div class="chat-vacio-icono">ðŸ’¬</div>
                    <h3>Selecciona una conversaciÃ³n</h3>
                    <p>Elige una conversaciÃ³n de la lista para comenzar a chatear</p>
                </div>

                <div id="chat-activo" class="chat-activo" style="display: none;">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <h3 id="chatNombrePaciente"></h3>
                            <span id="chatCelularPaciente" class="chat-celular"></span>
                        </div>
                        <div class="chat-header-acciones">
                            <button onclick="toggleBot()" id="btnToggleBot" class="btn-toggle-bot">
                                ðŸ¤– Bot: <span id="estadoBot">Activo</span>
                            </button>
                            <button onclick="abrirModalTransferir()" class="btn-secondary">Transferir</button>
                            <button onclick="cerrarConversacion()" class="btn-danger">Cerrar chat</button>
                        </div>
                    </div>

                    <!-- Mensajes -->
                    <div id="chatMensajes" class="chat-mensajes">
                        <!-- Los mensajes se cargarÃ¡n aquÃ­ -->
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input-area">
                        <textarea
                            id="mensajeInput"
                            placeholder="Escribe tu mensaje..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button onclick="enviarMensaje()" class="btn-enviar">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Info Panel -->
            <aside class="info-panel" id="infoPanel">
                <div class="info-header">
                    <h3>InformaciÃ³n del Paciente</h3>
                    <button onclick="toggleInfoPanel()" class="btn-collapse">Ã—</button>
                </div>

                <div class="info-content">
                    <div class="info-section">
                        <h4>Datos Personales</h4>
                        <div class="info-item">
                            <span class="info-label">Nombre:</span>
                            <span id="infoNombre" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Celular:</span>
                            <span id="infoCelular" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ID:</span>
                            <span id="infoId" class="info-value">-</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>ConversaciÃ³n</h4>
                        <div class="info-item">
                            <span class="info-label">Estado:</span>
                            <span id="infoEstado" class="info-value badge">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Canal:</span>
                            <span id="infoCanal" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prioridad:</span>
                            <span id="infoPrioridad" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Inicio:</span>
                            <span id="infoFechaInicio" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ãšltima actividad:</span>
                            <span id="infoUltimaActividad" class="info-value">-</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>Etiquetas</h4>
                        <div id="infoEtiquetas" class="info-etiquetas">
                            <!-- Etiquetas dinÃ¡micas -->
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal: Transferir ConversaciÃ³n -->
    <div id="modalTransferir" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Transferir ConversaciÃ³n</h3>
                <button onclick="cerrarModalTransferir()" class="btn-close">Ã—</button>
            </div>
            <div class="modal-body">
                <label for="selectAgenteDestino">Seleccionar agente:</label>
                <select id="selectAgenteDestino" class="form-select">
                    <option value="">Cargando agentes...</option>
                </select>

                <label for="motivoTransferencia">Motivo (opcional):</label>
                <textarea id="motivoTransferencia" rows="3" placeholder="RazÃ³n de la transferencia..."></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="cerrarModalTransferir()" class="btn-secondary">Cancelar</button>
                <button onclick="confirmarTransferencia()" class="btn-primary">Transferir</button>
            </div>
        </div>
    </div>

    <!-- NotificaciÃ³n Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Variables globales
        let conversacionActiva = null;
        let eventSource = null;
        let agentesDisponibles = [];
        let conversaciones = [];

        // Auth Helper
        const Auth = {
            getToken() {
                return localStorage.getItem('bsl_auth_token');
            },

            getUsuario() {
                const userData = localStorage.getItem('bsl_user');
                return userData ? JSON.parse(userData) : null;
            },

            async fetchAuth(url, options = {}) {
                const token = this.getToken();
                if (!token) {
                    window.location.href = '/login.html';
                    throw new Error('No hay token');
                }

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                };

                const response = await fetch(url, { ...options, headers });

                if (response.status === 401) {
                    localStorage.removeItem('bsl_auth_token');
                    localStorage.removeItem('bsl_user');
                    window.location.href = '/login.html';
                    throw new Error('SesiÃ³n expirada');
                }

                return response;
            }
        };

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = Auth.getUsuario();
            if (!usuario) {
                window.location.href = '/login.html';
                return;
            }

            // Verificar que sea agente_chat
            if (usuario.rol !== 'agente_chat') {
                mostrarToast('No tienes acceso a este panel', 'error');
                setTimeout(() => window.location.href = '/', 3000);
                return;
            }

            document.getElementById('nombreAgente').textContent = usuario.nombre_completo || usuario.email;

            // Conectar SSE
            conectarSSE();

            // Cargar conversaciones
            await cargarConversaciones();

            // Auto-refresh cada 30 segundos
            setInterval(cargarConversaciones, 30000);
        });

        // Server-Sent Events
        function conectarSSE() {
            if (eventSource) {
                eventSource.close();
            }

            const token = Auth.getToken();
            eventSource = new EventSource(`/api/whatsapp/stream?token=${encodeURIComponent(token)}`);

            eventSource.addEventListener('connected', (e) => {
                console.log('[SSE] Conectado:', JSON.parse(e.data));
                mostrarToast('Conectado al sistema de notificaciones', 'success');
            });

            eventSource.addEventListener('nuevo_mensaje', async (e) => {
                const data = JSON.parse(e.data);
                console.log('[SSE] Nuevo mensaje:', data);

                // Si es de la conversaciÃ³n activa, cargar mensajes
                if (conversacionActiva && conversacionActiva.id === data.conversacion_id) {
                    await cargarMensajes(data.conversacion_id);
                }

                // Actualizar lista de conversaciones
                await cargarConversaciones();

                // NotificaciÃ³n sonora (opcional)
                reproducirSonidoNotificacion();

                // Mostrar toast
                mostrarToast('Nuevo mensaje recibido', 'info');
            });

            eventSource.addEventListener('nueva_conversacion', async (e) => {
                const data = JSON.parse(e.data);
                console.log('[SSE] Nueva conversaciÃ³n asignada:', data);

                await cargarConversaciones();
                mostrarToast('Nueva conversaciÃ³n asignada', 'info');
                reproducirSonidoNotificacion();
            });

            eventSource.addEventListener('conversacion_cerrada', async (e) => {
                const data = JSON.parse(e.data);
                console.log('[SSE] ConversaciÃ³n cerrada:', data);

                if (conversacionActiva && conversacionActiva.id === data.conversacion_id) {
                    conversacionActiva = null;
                    mostrarChatVacio();
                }

                await cargarConversaciones();
                mostrarToast('ConversaciÃ³n cerrada', 'info');
            });

            eventSource.onerror = (error) => {
                console.error('[SSE] Error:', error);
                setTimeout(() => conectarSSE(), 5000);
            };
        }

        // Cargar conversaciones
        async function cargarConversaciones() {
            try {
                const estado = document.getElementById('filtroEstado').value;
                const response = await Auth.fetchAuth(`/api/agentes/conversaciones?estado=${estado}&limit=100`);
                const data = await response.json();

                if (data.success) {
                    conversaciones = data.data;
                    renderizarConversaciones(conversaciones);
                    document.getElementById('contadorConversaciones').textContent = conversaciones.length;
                }
            } catch (error) {
                console.error('Error cargando conversaciones:', error);
                mostrarToast('Error cargando conversaciones', 'error');
            }
        }

        function renderizarConversaciones(conversacionesList) {
            const container = document.getElementById('listaConversaciones');

            if (conversacionesList.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay conversaciones</div>';
                return;
            }

            container.innerHTML = conversacionesList.map(conv => `
                <div class="conversacion-item ${conversacionActiva && conversacionActiva.id === conv.id ? 'active' : ''}"
                     onclick="seleccionarConversacion(${conv.id})">
                    <div class="conv-avatar">
                        ${conv.nombre_paciente ? conv.nombre_paciente.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div class="conv-info">
                        <div class="conv-header">
                            <h4>${conv.nombre_paciente || conv.celular}</h4>
                            <span class="conv-time">${formatearFechaRelativa(conv.timestamp_ultimo_mensaje || conv.fecha_ultima_actividad)}</span>
                        </div>
                        <div class="conv-preview">
                            <p>${conv.ultimo_mensaje || 'Sin mensajes'}</p>
                            ${conv.mensajes_no_leidos > 0 ? `<span class="badge-unread">${conv.mensajes_no_leidos}</span>` : ''}
                        </div>
                    </div>
                    ${conv.prioridad === 'urgente' ? '<span class="badge-urgente">URGENTE</span>' : ''}
                </div>
            `).join('');
        }

        function filtrarConversaciones() {
            const busqueda = document.getElementById('buscarConversacion').value.toLowerCase();
            const filtradas = conversaciones.filter(conv =>
                (conv.nombre_paciente || '').toLowerCase().includes(busqueda) ||
                (conv.celular || '').includes(busqueda)
            );
            renderizarConversaciones(filtradas);
        }

        // Seleccionar conversaciÃ³n
        async function seleccionarConversacion(id) {
            const conv = conversaciones.find(c => c.id === id);
            if (!conv) return;

            conversacionActiva = conv;

            // Mostrar chat activo
            document.getElementById('chat-vacio').style.display = 'none';
            document.getElementById('chat-activo').style.display = 'flex';

            // Actualizar header del chat
            document.getElementById('chatNombrePaciente').textContent = conv.nombre_paciente || conv.celular;
            document.getElementById('chatCelularPaciente').textContent = conv.celular;
            document.getElementById('estadoBot').textContent = conv.bot_activo ? 'Activo' : 'Inactivo';

            // Actualizar panel de informaciÃ³n
            actualizarPanelInfo(conv);

            // Cargar mensajes
            await cargarMensajes(id);

            // Marcar como activa en la lista
            renderizarConversaciones(conversaciones);
        }

        async function cargarMensajes(conversacionId) {
            try {
                const response = await Auth.fetchAuth(`/api/agentes/conversacion/${conversacionId}/mensajes`);
                const data = await response.json();

                if (data.success) {
                    renderizarMensajes(data.data);
                }
            } catch (error) {
                console.error('Error cargando mensajes:', error);
                mostrarToast('Error cargando mensajes', 'error');
            }
        }

        function renderizarMensajes(mensajes) {
            const container = document.getElementById('chatMensajes');

            if (mensajes.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay mensajes en esta conversaciÃ³n</div>';
                return;
            }

            container.innerHTML = mensajes.map(msg => `
                <div class="mensaje ${msg.direccion === 'salida' ? 'mensaje-salida' : 'mensaje-entrada'}">
                    <div class="mensaje-contenido">
                        ${msg.contenido}
                    </div>
                    <div class="mensaje-meta">
                        ${msg.agente_nombre ? `<span>${msg.agente_nombre}</span> â€¢ ` : ''}
                        <span>${formatearHora(msg.timestamp)}</span>
                    </div>
                </div>
            `).join('');

            // Scroll al final
            container.scrollTop = container.scrollHeight;
        }

        // Enviar mensaje
        async function enviarMensaje() {
            if (!conversacionActiva) {
                mostrarToast('Selecciona una conversaciÃ³n primero', 'warning');
                return;
            }

            const textarea = document.getElementById('mensajeInput');
            const contenido = textarea.value.trim();

            if (!contenido) return;

            try {
                const response = await Auth.fetchAuth(`/api/agentes/conversacion/${conversacionActiva.id}/mensaje`, {
                    method: 'POST',
                    body: JSON.stringify({ contenido })
                });

                const data = await response.json();

                if (data.success) {
                    textarea.value = '';
                    textarea.style.height = 'auto';
                    await cargarMensajes(conversacionActiva.id);
                } else {
                    mostrarToast(data.message || 'Error enviando mensaje', 'error');
                }
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                mostrarToast('Error enviando mensaje', 'error');
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensaje();
            }
        }

        // Cambiar estado del agente
        async function cambiarEstado() {
            const select = document.getElementById('estadoAgente');
            const estado = select.value;

            try {
                const response = await Auth.fetchAuth('/api/agentes/estado', {
                    method: 'PUT',
                    body: JSON.stringify({ estado })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast(`Estado cambiado a: ${estado}`, 'success');
                } else {
                    mostrarToast(data.message || 'Error cambiando estado', 'error');
                    select.value = 'disponible';
                }
            } catch (error) {
                console.error('Error cambiando estado:', error);
                mostrarToast('Error cambiando estado', 'error');
                select.value = 'disponible';
            }
        }

        // Toggle bot
        async function toggleBot() {
            if (!conversacionActiva) return;

            const botActivo = !conversacionActiva.bot_activo;

            try {
                const response = await Auth.fetchAuth(`/api/agentes/conversacion/${conversacionActiva.id}/bot`, {
                    method: 'PUT',
                    body: JSON.stringify({ bot_activo: botActivo })
                });

                const data = await response.json();

                if (data.success) {
                    conversacionActiva.bot_activo = botActivo;
                    document.getElementById('estadoBot').textContent = botActivo ? 'Activo' : 'Inactivo';
                    mostrarToast(`Bot ${botActivo ? 'activado' : 'desactivado'}`, 'success');
                } else {
                    mostrarToast(data.message || 'Error cambiando bot', 'error');
                }
            } catch (error) {
                console.error('Error toggle bot:', error);
                mostrarToast('Error cambiando bot', 'error');
            }
        }

        // Transferir conversaciÃ³n
        async function abrirModalTransferir() {
            if (!conversacionActiva) return;

            // Cargar agentes disponibles
            try {
                const response = await Auth.fetchAuth('/api/agentes/conversaciones');
                const data = await response.json();

                if (data.success) {
                    // Por ahora, simulamos lista de agentes (en el futuro agregar endpoint especÃ­fico)
                    const select = document.getElementById('selectAgenteDestino');
                    select.innerHTML = '<option value="">Seleccionar agente...</option>';
                    // TODO: Cargar agentes reales desde endpoint /api/admin/agentes
                }
            } catch (error) {
                console.error('Error cargando agentes:', error);
            }

            document.getElementById('modalTransferir').style.display = 'flex';
        }

        function cerrarModalTransferir() {
            document.getElementById('modalTransferir').style.display = 'none';
            document.getElementById('motivoTransferencia').value = '';
        }

        async function confirmarTransferencia() {
            const agenteId = document.getElementById('selectAgenteDestino').value;
            const motivo = document.getElementById('motivoTransferencia').value;

            if (!agenteId) {
                mostrarToast('Selecciona un agente', 'warning');
                return;
            }

            try {
                const response = await Auth.fetchAuth(`/api/agentes/conversacion/${conversacionActiva.id}/transferir`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        a_usuario_id: parseInt(agenteId),
                        motivo
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast('ConversaciÃ³n transferida', 'success');
                    cerrarModalTransferir();
                    conversacionActiva = null;
                    mostrarChatVacio();
                    await cargarConversaciones();
                } else {
                    mostrarToast(data.message || 'Error transfiriendo', 'error');
                }
            } catch (error) {
                console.error('Error transfiriendo:', error);
                mostrarToast('Error transfiriendo conversaciÃ³n', 'error');
            }
        }

        // Cerrar conversaciÃ³n
        async function cerrarConversacion() {
            if (!conversacionActiva) return;

            if (!confirm('Â¿EstÃ¡s seguro de cerrar esta conversaciÃ³n?')) return;

            try {
                const response = await Auth.fetchAuth(`/api/agentes/conversacion/${conversacionActiva.id}/cerrar`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast('ConversaciÃ³n cerrada', 'success');
                    conversacionActiva = null;
                    mostrarChatVacio();
                    await cargarConversaciones();
                } else {
                    mostrarToast(data.message || 'Error cerrando conversaciÃ³n', 'error');
                }
            } catch (error) {
                console.error('Error cerrando conversaciÃ³n:', error);
                mostrarToast('Error cerrando conversaciÃ³n', 'error');
            }
        }

        // Panel de informaciÃ³n
        function actualizarPanelInfo(conv) {
            document.getElementById('infoNombre').textContent = conv.nombre_paciente || '-';
            document.getElementById('infoCelular').textContent = conv.celular || '-';
            document.getElementById('infoId').textContent = conv.paciente_id || '-';
            document.getElementById('infoEstado').textContent = conv.estado || '-';
            document.getElementById('infoCanal').textContent = conv.canal || '-';
            document.getElementById('infoPrioridad').textContent = conv.prioridad || 'normal';
            document.getElementById('infoFechaInicio').textContent = formatearFecha(conv.fecha_inicio);
            document.getElementById('infoUltimaActividad').textContent = formatearFechaRelativa(conv.fecha_ultima_actividad);

            // Etiquetas
            const etiquetasContainer = document.getElementById('infoEtiquetas');
            if (conv.etiquetas && conv.etiquetas.length > 0) {
                etiquetasContainer.innerHTML = conv.etiquetas.map(etiqueta =>
                    `<span class="etiqueta">${etiqueta}</span>`
                ).join('');
            } else {
                etiquetasContainer.innerHTML = '<span class="info-value">Sin etiquetas</span>';
            }
        }

        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            panel.classList.toggle('collapsed');
        }

        function mostrarChatVacio() {
            document.getElementById('chat-vacio').style.display = 'flex';
            document.getElementById('chat-activo').style.display = 'none';
        }

        // Helpers
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            return new Date(fecha).toLocaleString('es-CO');
        }

        function formatearFechaRelativa(fecha) {
            if (!fecha) return '-';
            const ahora = new Date();
            const entonces = new Date(fecha);
            const diff = Math.floor((ahora - entonces) / 1000);

            if (diff < 60) return 'Hace un momento';
            if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
            return entonces.toLocaleDateString('es-CO');
        }

        function formatearHora(timestamp) {
            return new Date(timestamp).toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function mostrarToast(mensaje, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.className = `toast toast-${tipo} show`;

            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        function reproducirSonidoNotificacion() {
            // Opcional: agregar audio de notificaciÃ³n
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZjzsIHGKs6+2gUBELTKXh9rltJwg+j9X0znwxBB1qsOu6jjAHGV+t6+OdPwkWU6vj7bJaFApCmuL1vXMuBiqvuvHcnj0NBjyS2/PFb3UEAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZjzsIHGKs6+2gUBELTKXh9rltJwg+j9X0znwxBB1qsOu6jjAHGV+t6+OdPwkWU6vj7bJaFApCmuL1vXMuBiq0Y6TIQJjEwV2A3/LCZzQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=');
                audio.play().catch(e => console.log('No se pudo reproducir sonido'));
            } catch (e) {}
        }

        function cerrarSesion() {
            if (eventSource) {
                eventSource.close();
            }
            localStorage.removeItem('bsl_auth_token');
            localStorage.removeItem('bsl_user');
            window.location.href = '/login.html';
        }

        // Auto-ajuste del textarea
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('mensajeInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });
    </script>
</body>
</html>
